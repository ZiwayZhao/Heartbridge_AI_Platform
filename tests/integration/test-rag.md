# RAG 功能测试指南

## 测试目的
验证 HeartBridge 的 RAG（检索增强生成）功能是否正常工作。

## 测试步骤

### 1. 检查知识库数据
首先确认知识库中有数据且已向量化：

```sql
-- 检查知识库条目数量和向量化状态
SELECT 
  COUNT(*) as total_count,
  SUM(CASE WHEN embedding IS NOT NULL THEN 1 ELSE 0 END) as vectorized_count,
  SUM(CASE WHEN embedding IS NULL THEN 1 ELSE 0 END) as not_vectorized_count
FROM knowledge_units;

-- 查看样本数据
SELECT id, content, category, importance, embedding IS NOT NULL as has_embedding
FROM knowledge_units
LIMIT 5;
```

### 2. 测试向量搜索功能
使用已知的知识库问题测试搜索：

测试问题示例（这些问题的答案应该在知识库中）：
- 中文: "自闭症儿童在遇到困难时常见的行为反应是什么？"
- 中文: "教孩子说帮我时，强化策略应该怎样安排？"
- 中文: "当孩子在等待时哭或伸手抢东西怎么办？"

预期行为：
1. AI 应该从知识库中检索到相关内容
2. 回答应该基于知识库中的信息
3. 回答应该准确且相关

### 3. 检查 Edge Function 日志
在聊天后检查 `heartbridge-chat` 函数的日志：

```bash
# 查看最近的函数调用日志
# 应该能看到：
# - 向量搜索的执行
# - 找到的相似度分数
# - 使用的上下文
```

### 4. 验证完整流程

#### 4.1 登录
1. 访问 `/auth` 页面
2. 使用测试账号登录或注册新账号
3. 确认登录后跳转到主页

#### 4.2 测试聊天
1. 在主页的聊天界面输入测试问题
2. 等待 AI 回复
3. 检查回复是否基于知识库内容

#### 4.3 管理员功能（需要管理员权限）
1. 以管理员身份登录
2. 访问知识库管理页面 `/knowledge`
3. 验证可以查看、编辑、删除知识单元

## 常见问题排查

### 问题1: AI 回答不基于知识库
**可能原因：**
- 知识库数据未向量化
- 向量搜索相似度阈值过高
- Edge function 错误

**解决方案：**
1. 检查 embedding 列是否为 NULL
2. 降低 `match_threshold` 参数（默认 0.7）
3. 查看 Edge Function 日志

### 问题2: 登录后无法访问页面
**可能原因：**
- RLS 策略配置错误
- 用户角色未正确分配

**解决方案：**
1. 检查 `user_roles` 表中的角色分配
2. 验证 RLS 策略
3. 确认 `has_role` 函数正常工作

### 问题3: 知识库管理页面无法加载
**可能原因：**
- 非管理员用户访问
- 数据库查询错误

**解决方案：**
1. 确认用户具有 admin 角色
2. 检查浏览器控制台错误
3. 查看网络请求响应

## 测试清单

- [ ] 知识库数据已向量化
- [ ] 向量搜索功能正常
- [ ] 登录/注册功能正常
- [ ] 用户会话持久化
- [ ] RAG 检索返回相关内容
- [ ] AI 回答基于知识库
- [ ] 管理员可以访问知识库管理
- [ ] 普通用户无法访问管理页面
- [ ] 中英文界面切换正常
- [ ] 所有 API 调用成功

## 成功标准

1. ✅ 用户可以成功登录并保持会话
2. ✅ 提问知识库中的问题时，AI 能检索到相关内容
3. ✅ AI 的回答准确且基于知识库数据
4. ✅ 管理员可以正常管理知识库
5. ✅ 中英文界面都能正常使用
6. ✅ 所有数据库交互正常，无权限错误
